defaults: &defaults
  working_directory: /routemaster
  docker:
    - image: marcinw/circle:latest

version: 2

jobs:
  run_tests:
    <<: *defaults

    parallelism: 8

    steps:
      - setup_remote_docker:
          reusable: true

      - checkout

      - run:
          name: Ensure clean slate
          command: bin/ci down

      - run:
          name: Build composition
          command: bin/ci build

      - run:
          name: Wait for Redis to start
          command: bin/ci run --rm wait redis:6379

      - run:
          name: Run RSpec and report test results
          command: bin/ci run --rm app bin/test_and_report

  build_image:
    <<: *defaults

    steps:
      - setup_remote_docker:
          reusable: true

      - checkout

      - run:
          name: Build production image
          command: docker build -f Dockerfile -t routemaster .

workflows:
  version: 2
  test_and_build:
    jobs:
      - run_tests
      - build_image
